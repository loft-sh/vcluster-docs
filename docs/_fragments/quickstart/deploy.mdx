import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import CodeBlock from '@theme/CodeBlock';

import TerraformDeployFile from '!!raw-loader!@site/docs/_fragments/quickstart/terraform-deploy-main.tf'

Deploy a vCluster instance called `my-vcluster` into namespace `team-x` using the `vcluster.yaml` we created in step 2. 

<Tabs
  groupId="get-started"
  defaultValue="cli"
  values={[
	{ label: "CLI", value: "cli" },
    { label: 'Helm', value: 'helm', },
    { label: 'kubectl', value: 'kubectl', },
    { label: 'Terraform', value: 'terraform', },
    { label: 'Argo CD', value: 'argo', },
    { label: 'Cluster API', value: 'cluster-api', },
  ]
}>
<TabItem value="cli">

```bash
kubectl create namespace team-x
```

```bash
vcluster create my-vcluster --namespace team-x --values vcluster.yaml
```

When the installation finishes, you are automatically connected to the virtual cluster and you can start running kubectl commands within the virtual cluster.

</TabItem>
<TabItem value="helm">

```bash
kubectl create namespace team-x
```

```bash
helm upgrade --install my-vcluster vcluster \
  --values vcluster.yaml \
  --repo https://charts.loft.sh \
  --namespace team-x \
  --repository-config=''
```

If you don't have custom configuration, remove the `--values vcluster.yaml` line.

</TabItem>
<TabItem value="kubectl">

This uses Helm to generate the Kubernetes deployment files before applying with `kubectl`.

```bash
kubectl create namespace team-x
```

```bash
helm template my-vcluster vcluster --repo https://charts.loft.sh -n team-x -f vcluster.yaml | kubectl apply -f -
```

</TabItem>
<TabItem value="terraform">

1. Create a `main.tf` file with the following content.

   <CodeBlock language="hcl">{TerraformDeployFile}</CodeBlock>

1. Install the required [Helm provider](https://registry.terraform.io/providers/hashicorp/helm/latest).

   ```bash
   terraform init
   ```

1. Generate a plan. 
    
    ```bash
    terraform plan
    ```

   Verify that the provider can access your cluster and that the proposed changes are correct.

1. Deploy vCluster.

   ```bash
   terraform apply
   ```

</TabItem>
<TabItem value="argo">

To deploy vCluster using ArgoCD, you need the following files:

- `vcluster.yaml` for your vCluster configuration. This is optional if you are deploying with default configuration.
- `my-vcluster.yaml` for your ArgoCD `Application` definition.


1. Create the ArgoCD `Application` file `my-vcluster.yaml`. Deployment uses the vCluster Helm chart and the previously created `vcluster.yaml` file to pass the chart values, but you may use any of the options for passing values covered by the [ArgoCD Helm documentation](https://argo-cd.readthedocs.io/en/stable/user-guide/helm). 

   ```yaml
   apiVersion: argoproj.io/v1alpha1
   kind: Application
   metadata:
     name: my-vcluster
     namespace: argocd
   spec:
     project: default
     source:
       chart: vcluster
       repoURL: https://charts.loft.sh
       helm:
         releaseName: my-vcluster
         valueFiles:
           - vcluster.yaml
     destination:
       server: https://kubernetes.default.svc
       namespace: team-x
   ```

1. Commit and push these files to your configured ArgoCD repository and synchronize it with your configured cluster.

</TabItem>
<TabItem value="cluster-api">

1. Install the `clusterctl` CLI according to the [install instructions](https://cluster-api.sigs.k8s.io/user/quick-start.html#install-clusterctl) for your platform.

1. Install the vCluster provider:

   ```bash
   clusterctl init --infrastructure vcluster
   ```

1. Generate the required manifests and apply using `clusterctl generate cluster` and `kubectl`.

   ```bash
   export CLUSTER_NAME=my-vcluster
   export CLUSTER_NAMESPACE=team-x
   export KUBERNETES_VERSION=1.29.3
   export HELM_VALUES=$(cat vcluster.yaml)

   kubectl create namespace ${CLUSTER_NAMESPACE}

   clusterctl generate cluster ${CLUSTER_NAME} \
    --infrastructure vcluster \
    --kubernetes-version ${KUBERNETES_VERSION} \
    --target-namespace ${CLUSTER_NAMESPACE} | kubectl apply -f -
   ```

1. Execute the following command to wait for the vCluster custom resource to report a ready status:

   ```bash
   kubectl wait --for=condition=ready vcluster -n $CLUSTER_NAMESPACE $CLUSTER_NAME --timeout=300s
   ```
Learn more about [Cluster API Provider for vCluster](https://github.com/loft-sh/cluster-api-provider-vcluster)
</TabItem>
</Tabs>