---
title: Storage
sidebar_label: Storage
---

import Prereqs from '@site/docs/_fragments/volume-snapshots-host-prereqs.mdx'

<figure>
  <img src="/docs/media/diagrams/vcluster-persistent-volume-provisioning.svg" alt="vcluster Persistent Volume Provisioning" />
  <figcaption>vcluster - Persistent Volume Provisioning</figcaption>
</figure>

Since the vCluster's Syncer synchronizes pods to the host cluster to schedule them, you can use the storage classes of the host cluster to create persistent volume claims and to mount persistent volumes. By default, you can use the host's storage classes without the need to create storage classes in the virtual cluster. 

## Sync persistent volumes to the host cluster

By default, creating persistent volumes in the virtual cluster has no effect, as the virtual cluster runs without any cluster-scoped access in the host cluster. However, if you enable syncing persistent volumes, vCluster creates the appropriate ClusterRole in the host cluster.

When you create a persistent volume in the virtual cluster:

1. vCluster creates a persistent volume in the host cluster with the name  `vcluster-<persistent-volume-name>-x-<vcluster-namespace>-x-<vcluster-name>`, replacing the placeholders with data from your host cluster and vCluster instance. vCluster creates this new name to avoid conflicts with existing persistent volumes.
1. vCluster rewrites persistent volume claims with the new name so that it seems that the virtual name is bound.
1. vCluster syncs the virtual cluster's persistent volume to the host cluster. 

For example, when you create a PersistentVolumeClaim in the form of:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: persistent-volume-claim
spec:
  storageClassName: my-storage-class
  volumeName: my-persistent-volume
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

vCluster rewrites this PersistentVolumeClaim into the following in the host cluster to prevent any conflicts with already existing storage classes or persistent volumes:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: persistent-volume-claim-x-<vcluster-namespace>-x-<vcluster-name>
spec:
  storageClassName: vcluster-my-storage-class-<vcluster-namespace>-x-<vcluster-name>
  volumeName: vcluster-my-persistent-volume-<vcluster-namespace>-x-<vcluster-name>
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

There might be cases where you want to disable this automatic rewriting of persistent volume claims (for example if you want to mount an already existing PV of the host cluster to a PVC in the vCluster), for that case you can set the annotation called `vcluster.loft.sh/skip-translate` to `true`, which will tell vCluster to not rewrite the PVC `volumeName`, `storageClass`, `selectors` or `dataSource`.

See the `vcluster.yaml` reference to configure the following:
- [Persistent volumes](/vcluster-yaml/sync/to-host/storage/persistent-volumes.mdx).
- [Persistent volume claims](/vcluster-yaml/sync/to-host/storage/persistent-volume-claims.mdx).

## Sync volume snapshots

Kubernetes' [VolumeSnapshot](https://kubernetes.io/docs/concepts/storage/volume-snapshots/) resource represents a snapshot of a volume on a storage system. 

By default, VolumeSnapshot syncing is disabled, and creating a VolumeSnapshot custom resource in the virtual cluster has no effect on the host cluster. 

See the `vcluster.yaml` reference to [configure](/vcluster-yaml/sync/to-host/storage/volume-snapshots.mdx) volume snapshots.

### Host prerequisites

<Prereqs/>

### How syncing works

When you enable syncing volume snapshots, vCluster watches VolumeSnapshot, VolumeSnapshotContent, and VolumeSnapshotClass resources created in the virtual cluster and syncs them from the virtual cluster to the host cluster. 

vCluster syncs these resource type in the following ways:

- **VolumeSnapshot**: vCluster syncs resources created in the virtual cluster to the host cluster.

  - The name is in form of `vcluster-<volume-snapshot-name>-x-<volume-snapshot-namespace>-x-<vcluster-name>`. - vCluster syncs the status and finalizers of this resource back to its virtual cluster respresentation. 
  - vCluster rewrites the `.spec.source` field of the VolumeSnapshot resource in the host cluster to reference the expected PersistentVolumeClaim or VolumeSnapshotContent resource.

- **VolumeSnapshotContent**: vCluster syncs resources created in the virtual cluster to the host cluster.

  - The name is in form of `vcluster-<volume-snapshot-name>-x-<vcluster-namespace>-x-<vcluster-name>`.
  - vCluster syncs VolumeSnapshotContent resources created in the host cluster and referencing VolumeSnapshot from the virtual cluster into the virtual cluster.
  - vCluster syncs the status and finalizers of this resource back to its virtual cluster respresentation.
  - vCluster overwrites the `.spec.volumeSnapshotRef` field of the VolumeSnapshotContent resource to reference the expected VolumeSnapshot resource.

- **VolumeSnapshotClass** resources will be synced from the host cluster into vCluster only.

## Related content

- [Configure](/vcluster-yaml/sync/from-host/storage-classes.mdx) storage sync from the host cluster to the virtual cluster.
- [Configure](/vcluster-yaml/sync/to-host/storage/storage-classes.mdx) class sync from the virtual cluster to the host cluster.


