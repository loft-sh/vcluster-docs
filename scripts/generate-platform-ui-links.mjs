#!/usr/bin/env node

import fs from "node:fs"
import path from "node:path"

const args = new Set(process.argv.slice(2))
const checkMode = args.has("--check")

const repoRoot = process.cwd()
const contractPath = path.join(repoRoot, "config/platform-ui-links.contract.json")
const netlifyPath = path.join(repoRoot, "netlify.toml")
const manifestPath = path.join(repoRoot, "static/platform-ui-links-manifest.json")

const START_MARKER = "# PLATFORM-UI-LINKS START"
const END_MARKER = "# PLATFORM-UI-LINKS END"

if (!fs.existsSync(contractPath)) {
  console.error(`Missing contract file: ${contractPath}`)
  process.exit(1)
}

const contract = JSON.parse(fs.readFileSync(contractPath, "utf8"))
const links = Array.isArray(contract.links) ? contract.links : []
const verify = contract.verify ?? {}

for (const link of links) {
  for (const required of ["key", "product", "slug", "targetLatest", "targetVersioned"]) {
    if (!link[required]) {
      console.error(`Invalid contract entry, missing '${required}':`, link)
      process.exit(1)
    }
  }
}

const seenKeys = new Set()
for (const link of links) {
  if (seenKeys.has(link.key)) {
    console.error(`Duplicate key in contract: ${link.key}`)
    process.exit(1)
  }
  seenKeys.add(link.key)
}

const sortedLinks = [...links].sort((a, b) => {
  if (a.product !== b.product) return a.product.localeCompare(b.product)
  return a.slug.localeCompare(b.slug)
})

const netlifyCurrent = fs.readFileSync(netlifyPath, "utf8")
const markersRegex = new RegExp(`${START_MARKER}[\\s\\S]*?${END_MARKER}`, "m")
if (!markersRegex.test(netlifyCurrent)) {
  console.error("Could not find platform-ui-links markers in netlify.toml")
  process.exit(1)
}
const netlifyNext = netlifyCurrent.replace(markersRegex, `${START_MARKER}\n# Generated by scripts/generate-platform-ui-links.mjs\n\n${sortedLinks
  .map((link) => {
    return [
      `# ${link.key}`,
      "[[redirects]]",
      `  from = \"/docs/platform-ui-link/${link.product}/${link.slug}\"`,
      `  to = \"${link.targetLatest}\"`,
      "",
      "[[redirects]]",
      `  from = \"/docs/platform-ui-link/${link.product}/${link.slug}/:version\"`,
      `  to = \"${link.targetVersioned}\"`,
      "",
    ].join("\n")
  })
  .join("\n")}${END_MARKER}`)

const manifest = {
  schemaVersion: contract.schemaVersion ?? 1,
  sourceContract: "config/platform-ui-links.contract.json",
  verify: {
    platformVersion: verify.platformVersion ?? "4.6.0",
    vclusterVersions: Array.isArray(verify.vclusterVersions) ? verify.vclusterVersions : ["0.29.0"],
  },
  links: sortedLinks.map((link) => ({
    key: link.key,
    product: link.product,
    slug: link.slug,
    minVersion: link.minVersion ?? null,
  })),
}
const manifestNext = `${JSON.stringify(manifest, null, 2)}\n`

if (checkMode) {
  const diffs = []

  if (netlifyCurrent !== netlifyNext) {
    diffs.push(netlifyPath)
  }

  if (!fs.existsSync(manifestPath) || fs.readFileSync(manifestPath, "utf8") !== manifestNext) {
    diffs.push(manifestPath)
  }

  if (diffs.length > 0) {
    console.error("Generated platform-ui-links files are out of date:")
    for (const file of diffs) console.error(`- ${file}`)
    console.error("Run: node scripts/generate-platform-ui-links.mjs")
    process.exit(1)
  }

  console.log("Generated platform-ui-links files are up to date.")
  process.exit(0)
}

fs.writeFileSync(netlifyPath, netlifyNext, "utf8")
fs.mkdirSync(path.dirname(manifestPath), { recursive: true })
fs.writeFileSync(manifestPath, manifestNext, "utf8")

console.log(`Wrote ${netlifyPath}`)
console.log(`Wrote ${manifestPath}`)
