name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - 'vendor/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.repository_owner == 'loft-sh'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Claude Review & Summary
        id: claude-review
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        with:
          github_token: ${{ secrets.GH_ACCESS_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          additional_permissions: |
            actions: write
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            COMMIT: ${{ github.event.pull_request.head.sha }}

            The PR branch is already checked out in the current working directory.

            ## Task 1: Review
            First, check existing PR comments and reviews using `gh pr view` to avoid duplicating feedback.
            Review this pull request. Read CONTRIBUTING.md for style guidelines.

            Focus on:
            - Documentation style adherence (per CONTRIBUTING.md)
            - Broken links or incorrect paths
            - Actual bugs or issues that would break functionality
            - Security concerns with real impact
            Only add inline comments for issues that genuinely need attention. Quality over quantity.

            ## vCluster YAML Validation
            If the PR adds or modifies vCluster YAML configurations (vcluster.yaml, values.yaml, or YAML code blocks in docs):
            - Use mcp__vcluster-yaml__validate-config to validate the YAML
            - Use mcp__vcluster-yaml__smart-query to verify configuration options exist
            - Report any validation errors as inline comments on the specific lines

            ## Task 2: Summary
            Update the PR description with a summary between the markers:
            <!-- CLAUDE_SUMMARY -->
            <!-- /CLAUDE_SUMMARY -->

            Use this exact format (GitHub callout style):
            ```
            <!-- CLAUDE_SUMMARY -->
            > [!NOTE]
            > One-line summary of what this PR does.
            >
            > - **Section/Area**
            >   - Bullet point of specific change
            > - **Another Section**
            >   - Another bullet point
            >
            > <sup>Generated by Claude for commit COMMIT_SHA. Updates automatically on new commits.</sup>
            <!-- /CLAUDE_SUMMARY -->
            ```

            Replace COMMIT_SHA with the actual commit hash.
            If markers don't exist in PR body, append them at the end.

            ## Task 3: Review Status Comment
            After completing the review, ALWAYS post a PR comment using `gh pr comment` with the review status:
            - If issues were found: "Review complete for COMMIT_SHA - X issue(s) flagged as inline comments."
            - If no issues: "Review complete for COMMIT_SHA - no issues found."

            ## Task 4: E2E Test Triggering
            Decide if e2e integration tests should run based on the PR changes:
            - TRIGGER if: changes to mermaid diagrams, significant doc structure changes, or test-related files
            - SKIP if: minor text edits, typo fixes, or non-visual changes

            If triggering, add the `run-e2e` label to the PR:
            1. First check if label exists: `gh pr view ${{ github.event.pull_request.number }} --json labels -q '.labels[].name' | grep -q run-e2e`
            2. If exists, remove it first: `gh pr edit ${{ github.event.pull_request.number }} --remove-label run-e2e`
            3. Then add it: `gh pr edit ${{ github.event.pull_request.number }} --add-label run-e2e`

            Include your decision (triggered or skipped with reason) in the review status comment.

          claude_args: |
            --model claude-opus-4-5-20251101 --mcp-config '{"mcpServers":{"vcluster-yaml":{"command":"npx","args":["-y","vcluster-yaml-mcp-server@latest"]}}}' --allowedTools "Read,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr edit:*),Bash(gh pr view:* | grep:*),Bash(gh api:*),Bash(git diff:*),Bash(git diff:* | xargs:*),Bash(git log:*),Bash(gh workflow run:*),mcp__github_inline_comment__create_inline_comment,mcp__vcluster-yaml__*"

      - name: Comment on failure
        if: steps.claude-review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Claude Code review failed to complete. This may be due to API rate limits or network issues. The PR can still be reviewed manually.'
            })
