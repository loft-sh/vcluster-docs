name: Platform UI Links Check

on:
  pull_request:
    paths:
      - "platform/**"
      - "platform_versioned_docs/**"
      - "vcluster/**"
      - "vcluster_versioned_docs/**"
      - "netlify.toml"
      - "config/platform-ui-links.contract.json"
      - "scripts/generate-platform-ui-links.mjs"
      - "scripts/validate-platform-ui-links-targets.mjs"
      - "static/platform-ui-links-manifest.json"

permissions:
  contents: read
  checks: read
  statuses: read

jobs:
  contract-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check generated contract outputs
        run: node scripts/generate-platform-ui-links.mjs --check

  permalink-liveness-preview:
    runs-on: ubuntu-latest
    needs: contract-check
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Wait for Netlify deploy check success
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha }}
        id: wait_netlify
        run: |
          set -euo pipefail

          for i in {1..60}; do
            CHECKS_JSON=$(curl -fsSL \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/commits/$SHA/check-runs")

            STATUS_JSON=$(curl -fsSL \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/commits/$SHA/status")

            MATCHING_CHECKS=$(echo "$CHECKS_JSON" | jq '[.check_runs[] | select((.app.slug // "" | ascii_downcase) == "netlify" or (.name | ascii_downcase | test("netlify")))]')
            MATCHING_STATUSES=$(echo "$STATUS_JSON" | jq '[.statuses[] | select((.context | ascii_downcase | test("netlify")))]')

            CHECK_SUCCESS=$(echo "$MATCHING_CHECKS" | jq '[.[] | select(.status == "completed" and .conclusion == "success")] | length')
            CHECK_FAILED=$(echo "$MATCHING_CHECKS" | jq '[.[] | select(.status == "completed" and (.conclusion == "failure" or .conclusion == "cancelled" or .conclusion == "timed_out" or .conclusion == "action_required" or .conclusion == "startup_failure"))] | length')

            STATUS_SUCCESS=$(echo "$MATCHING_STATUSES" | jq '[.[] | select(.state == "success")] | length')
            STATUS_FAILED=$(echo "$MATCHING_STATUSES" | jq '[.[] | select(.state == "failure" or .state == "error")] | length')

            TOTAL_MATCHES=$(echo "$MATCHING_CHECKS" | jq 'length')
            TOTAL_MATCHES=$((TOTAL_MATCHES + $(echo "$MATCHING_STATUSES" | jq 'length')))

            if [ "$TOTAL_MATCHES" -gt 0 ]; then
              if [ "$CHECK_FAILED" -gt 0 ] || [ "$STATUS_FAILED" -gt 0 ]; then
                echo "Netlify deploy signal finished with non-success conclusion/state."
                echo "$MATCHING_CHECKS" | jq -r '.[] | "check: \(.name) status=\(.status) conclusion=\(.conclusion)"'
                echo "$MATCHING_STATUSES" | jq -r '.[] | "status: \(.context) state=\(.state) url=\(.target_url // "")"'
                exit 1
              fi

              if [ "$CHECK_SUCCESS" -gt 0 ] || [ "$STATUS_SUCCESS" -gt 0 ]; then
                echo "Netlify deploy signal completed successfully."
                echo "$MATCHING_CHECKS" | jq -r '.[] | "check: \(.name) status=\(.status) conclusion=\(.conclusion)"'
                echo "$MATCHING_STATUSES" | jq -r '.[] | "status: \(.context) state=\(.state) url=\(.target_url // "")"'

                TARGET_URL=$(echo "$MATCHING_CHECKS" | jq -r '[.[] | select(.status == "completed" and .conclusion == "success") | .details_url // ""] | map(select(length > 0)) | first // empty')
                if [ -z "$TARGET_URL" ]; then
                  TARGET_URL=$(echo "$MATCHING_STATUSES" | jq -r '[.[] | select(.state == "success") | .target_url // ""] | map(select(length > 0)) | first // empty')
                fi
                DEPLOY_ID=$(echo "$TARGET_URL" | sed -nE 's#^.*/deploys/([a-f0-9]+).*$#\1#p')
                echo "netlify_target_url=$TARGET_URL" >> "$GITHUB_OUTPUT"
                echo "netlify_deploy_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
                break
              fi
            fi

            echo "Waiting for Netlify deploy signal to complete successfully (attempt $i/60)..."
            if [ "$TOTAL_MATCHES" -gt 0 ]; then
              echo "$MATCHING_CHECKS" | jq -r '.[] | "check: \(.name) status=\(.status) conclusion=\(.conclusion)"'
              echo "$MATCHING_STATUSES" | jq -r '.[] | "status: \(.context) state=\(.state)"'
            fi
            sleep 10

            if [ "$i" -eq 60 ]; then
              echo "Timed out waiting for Netlify deploy signal success."
              echo "$MATCHING_CHECKS" | jq -r '.[] | "check: \(.name) status=\(.status) conclusion=\(.conclusion)"' || true
              echo "$MATCHING_STATUSES" | jq -r '.[] | "status: \(.context) state=\(.state) url=\(.target_url // "")"' || true
              exit 1
            fi
          done

      - name: Wait for Netlify deployment state
        env:
          DEPLOY_ID: ${{ steps.wait_netlify.outputs.netlify_deploy_id }}
        run: |
          set -euo pipefail

          if [ -z "${DEPLOY_ID:-}" ]; then
            echo "No Netlify deploy id found in check/status payload. Skipping Netlify deploy-state polling."
            exit 0
          fi

          echo "Waiting for Netlify deploy state=ready for deploy id: $DEPLOY_ID"
          for i in {1..60}; do
            DEPLOY_JSON=$(curl -fsSL "https://api.netlify.com/api/v1/deploys/$DEPLOY_ID")
            DEPLOY_STATE=$(echo "$DEPLOY_JSON" | jq -r '.state // "unknown"')
            DEPLOY_URL=$(echo "$DEPLOY_JSON" | jq -r '.deploy_ssl_url // .deploy_url // ""')
            echo "Attempt $i/60: deploy_state=$DEPLOY_STATE deploy_url=$DEPLOY_URL"

            if [ "$DEPLOY_STATE" = "ready" ]; then
              exit 0
            fi
            if [ "$DEPLOY_STATE" = "error" ]; then
              echo "Netlify deploy is in error state."
              echo "$DEPLOY_JSON" | jq -r '{id,state,error_message,summary,deploy_ssl_url,deploy_url}'
              exit 1
            fi
            sleep 10
          done

          echo "Netlify deploy did not become ready in time for deploy id: $DEPLOY_ID"
          exit 1

      - name: Validate contract permalinks against preview
        run: |
          if [[ "${{ github.base_ref }}" == "next" || "${{ github.head_ref }}" == "next" ]]; then
            PREVIEW_URL="https://deploy-preview-${{ github.event.pull_request.number }}--next-vcluster-docs-site.netlify.app"
            IS_NEXT_BRANCH=true
          else
            PREVIEW_URL="https://deploy-preview-${{ github.event.pull_request.number }}--vcluster-docs-site.netlify.app"
            IS_NEXT_BRANCH=false
          fi

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/docs/")
          if [[ "$HTTP_STATUS" == "401" ]] && [[ "$IS_NEXT_BRANCH" == "true" ]]; then
            echo "Preview is password protected; skipping permalink liveness validation."
            exit 0
          fi

          DOCS_BASE_URL="$PREVIEW_URL" node scripts/validate-platform-ui-links-targets.mjs

  permalink-liveness-production:
    runs-on: ubuntu-latest
    needs: contract-check
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Validate contract permalinks against production
        run: |
          DOCS_BASE_URL="https://www.vcluster.com" node scripts/validate-platform-ui-links-targets.mjs
