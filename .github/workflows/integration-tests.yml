name: Integration Tests

on:
  pull_request:
    types:
      - labeled
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for deploy preview URL'
        required: true
        type: string
      test_url:
        description: 'URL to test (overrides deploy preview)'
        required: false
        type: string

concurrency:
  group: integration-tests-${{ inputs.pr_number || github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  cross-browser-tests:
    name: Cross-Browser Tests
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'workflow_dispatch') || (github.event_name == 'pull_request' && github.event.label.name == 'run-e2e') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: tests
        run: |
          npm install
          npx playwright install webkit chromium

      - name: Wait for Netlify Deploy Preview
        if: inputs.test_url == ''
        run: |
          PR_NUM="${{ github.event.pull_request.number || inputs.pr_number }}"
          PREVIEW_URL="https://deploy-preview-${PR_NUM}--vcluster-docs-site.netlify.app"
          echo "Waiting for Netlify preview: $PREVIEW_URL"
          for i in {1..60}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL/docs/vcluster")
            echo "Attempt $i: HTTP $HTTP_CODE"
            if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
              echo "TEST_BASE_URL=$PREVIEW_URL" >> $GITHUB_ENV
              echo "Preview ready at $PREVIEW_URL"
              exit 0
            fi
            sleep 10
          done
          echo "::error::Netlify preview not ready after 10 minutes. Cannot test against production."
          exit 1

      - name: Set test URL for manual runs
        if: github.event_name == 'workflow_dispatch' && inputs.test_url != ''
        run: echo "TEST_URL=${{ inputs.test_url }}" >> $GITHUB_ENV

      - name: Validate BrowserStack credentials
        run: |
          if [ -z "${{ secrets.BROWSERSTACK_USERNAME }}" ] || [ -z "${{ secrets.BROWSERSTACK_ACCESS_KEY }}" ]; then
            echo "Error: BrowserStack credentials not configured"
            exit 1
          fi

      - name: Run integration tests
        working-directory: tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          TEST_BASE_URL: ${{ env.TEST_BASE_URL }}
          TEST_URL: ${{ env.TEST_URL }}
        run: npm run test:browserstack

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-pr-${{ github.event.pull_request.number || github.run_id }}
          path: tests/screenshots/
          retention-days: 7
          overwrite: true
