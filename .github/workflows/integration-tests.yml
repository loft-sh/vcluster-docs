name: Integration Tests

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**.mdx'
      - '**.md'
      - 'docusaurus.config.js'
      - 'tests/**'
  workflow_dispatch:
    inputs:
      test_url:
        description: 'URL to test (leave empty for deploy preview)'
        required: false
        type: string

jobs:
  cross-browser-tests:
    name: Cross-Browser Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: tests
        run: npm ci

      - name: Wait for Netlify Deploy Preview
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.test_url == '')
        run: |
          # Build preview URL from PR number
          PREVIEW_URL="https://deploy-preview-${{ github.event.pull_request.number }}--vcluster-docs-site.netlify.app/docs/vcluster/deploy/worker-nodes/private-nodes/vpn"

          echo "Waiting for Netlify preview: $PREVIEW_URL"

          # Poll for up to 10 minutes
          for i in {1..60}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL")
            if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
              echo "Preview is ready! (HTTP $HTTP_CODE)"
              echo "TEST_URL=$PREVIEW_URL" >> $GITHUB_ENV
              exit 0
            fi
            echo "Attempt $i/60: HTTP $HTTP_CODE - waiting 10s..."
            sleep 10
          done

          echo "::warning::Netlify preview not ready after 10 minutes, falling back to production"
          echo "TEST_URL=https://vcluster.com/docs/vcluster/deploy/worker-nodes/private-nodes/vpn" >> $GITHUB_ENV

      - name: Set test URL for manual runs
        if: github.event_name == 'workflow_dispatch' && inputs.test_url != ''
        run: |
          echo "TEST_URL=${{ inputs.test_url }}" >> $GITHUB_ENV

      - name: Validate BrowserStack credentials
        run: |
          if [ -z "${{ secrets.BROWSERSTACK_USERNAME }}" ] || [ -z "${{ secrets.BROWSERSTACK_ACCESS_KEY }}" ]; then
            echo "Error: BrowserStack credentials not configured"
            echo "Please set BROWSERSTACK_USERNAME and BROWSERSTACK_ACCESS_KEY secrets"
            exit 1
          fi

      - name: Run integration tests
        working-directory: tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          TEST_URL: ${{ env.TEST_URL }}
        run: npm run test-browserstack

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-pr-${{ github.event.pull_request.number || github.run_id }}
          path: tests/screenshots/
          retention-days: 7
          overwrite: true

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          TEST_URL: ${{ env.TEST_URL }}
        with:
          script: |
            const fs = require('fs');
            const screenshotsDir = './tests/screenshots';
            const screenshots = fs.existsSync(screenshotsDir)
              ? fs.readdirSync(screenshotsDir).filter(f => f.endsWith('.png')).length
              : 0;

            const body = `## Integration Tests

            **Test URL**: ${process.env.TEST_URL}
            **Screenshots captured**: ${screenshots}

            Tests completed across 7 browsers (Safari, Chrome, Firefox)

            [View screenshots in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
