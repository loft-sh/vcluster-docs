name: cli-docs

on:
  repository_dispatch:
    types: [ update-cli-docs ]

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout vcluster repository
        uses: actions/checkout@v4
        with:
          repository: loft-sh/vcluster
          fetch-depth: 0
          ref: ${{ github.event.client_payload.ref }}
          path: vcluster-repo
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Setup Just
        uses: extractions/setup-just@v2
      - name: Generate cli docs
        working-directory: $GITHUB_WORKSPEC/vcluster-repo
        run: |
          just generate-cli-docs
      - name: Copy generated files
        env:
          PR_TITLE: ${{ github.event.client_payload.title }}
          PR_REF: ${{ github.event.client_payload.ref }}
          PR_VERSION: ${{ github.event.client_payload.version }}
        run: |
          cp -r vcluster-repo/vcluster/docs/pages/cli vcluster-docs/
          git checkout -b "CLI-DOC-$PR_REF"
          git add ./vcluster/cli
          git commit -m "DOC Update from {{ github.event.client_payload.title }}"
          git push origin "CLI-DOC-$PR_REF"
          gh pr create --base main -t "DOC Update from {{ github.event.client_payload.title }}" --body "Autogenerated PR for CLI docs"

