---
title: "Overview of Agent Settings"
sidebar_label: "Overview"
sidebar_position: 1
---

import Flow, { Step } from "@site/src/components/Flow";
import NavStep from "@site/src/components/NavStep";
import Button from "@site/src/components/Button";
import Label from "@site/src/components/Label";
import Input from "@site/src/components/Input";
import Expander from "@site/src/components/Expander";
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem'

import PartialClusterConnectUI from '../../_partials/cluster/connect-ui.mdx'
import PartialClusterConnectCLI from '../../_partials/cluster/connect-cli.mdx'
import PartialClusterConnectHelm from '../../_partials/cluster/connect-helm.mdx'

import BeforeSvg from '@site/static/media/agent/egress-only-before.excalidraw.svg';
import AfterSvg from '@site/static/media/agent/egress-only-after.excalidraw.svg';
import EnrollmentSvg from '@site/static/media/agent/egress-only-enrollment.excalidraw.svg';
import ConnectPlatform from '../../_fragments/cli-steps/connect-platform.mdx';


# Overview
When a **vCluster Platform** is deployed on a host cluster (or, primary host cluster), it can act as a centralized control plane. Other host clusters can connect to the vCluster Platform running on the primary host cluster and be managed by it. In this architecture:
- The primary host cluster runs the vCluster Platform.
- Other host clusters connect to the primary host cluster and run the vCluster Platform Agent.
- The Platform coordinates and manages all connected host clusters through their agents.
- There are both vCluster Platform and vCluster Platform agent running on the primary host cluster . The vCluster Platform manages the primary host cluster through its vCluster Platform Agent as well.

Agent settings are the content in the [`values.yaml`](../introduction.mdx) under the `agentValues`. It controls the behaviour of vCluster Platform Agents installed in the host clusters 
that are managed by the vCluster Platform.

The `agentValues` behavior is as follows:
- By default, `agentValues` is an empty list `{}`.
- An empty `agentValues` list means that agents installed on connected host clusters will inherit the same configuration as the platform running on the primary host cluster.
- You can populate `agentValues` to override the default agent configuration globally for all connected host clusters.

## Connect to primary host cluster
A new cluster can be connected to the platform through the UI or CLI:

<Tabs
  defaultValue="ui"
  values={[
    {label: 'UI', value: 'ui'},
    {label: 'CLI', value: 'cli'},
    {label: 'Helm', value: 'helm'},
  ]}>
  <TabItem value="ui">
    <PartialClusterConnectUI />
        :::tip Connect a cluster
UI will generate a CLI command that can be used to connect the cluster. Make
sure to check the `CLI` tab for working with the command.
:::


  </TabItem>
  <TabItem value="cli">
    <PartialClusterConnectCLI />


  :::info platform login
    <ConnectPlatform />

  If your kubectl context is not set to the cluster with running platform, it's
  possible to login to the platform using the CLI and access key.
  If you haven't already, you need to [create access key](/docs/platform/api/authentication#create-an-access-key) to be able to login to the platform.

  ```bash title="Login to the platform using access key"
  vcluster platform login [platform-url] --access-key [access-key]
  ```

  :::

  </TabItem>
  <TabItem value="helm">
    <PartialClusterConnectHelm />
  </TabItem>
</Tabs>

When connecting a new cluster, the user creates a new cluster resource and obtains
a pre-shared key (PSK) that the user then uses to bootstrap the agent.
The agent then utilizes this key to reach the control plane, authenticate itself,
and establish a secure WireGuard-based, user-space tunnel.

<EnrollmentSvg width="100%"/>

If the agent cannot establish a direct WireGuard-based connection, the agents
falls back to utilising the control plane as a Designated Encrypted Relay for Packets.
The control plane relay is comparable to the same role as TURN servers in the ICE
standard, using HTTPS streams (or WebSockets) and WireGuards keys instead.

:::info
If you encounter issues while configuring agent values or deploying it manually, you might want to take a look at the [Cluster troubleshooting](troubleshooting.mdx) guide.
:::


## Customize agent per host cluster

As described [here](../installation-options/overview#installation-modes), the vCluster Platform Agent can be installed using the same `vcluster-platform` chart by setting `agentOnly: true`. And the configuration of 
the agent by default will be decided by the configuration of the platform in the primary host cluster and the `agentValues` content.

However, this means that all host clusters connecting to the platform will share the same configuration. If different connected host clusters require different agent configurations, there are two supported approaches.

### `loft.sh/agent-values` annotation {#loftsh-annotations}
Add the `loft.sh/agent-values` annotation to a specific Cluster resource (via the UI or YAML). This annotation overrides the platform-level `agentValues`. The override applies only to the annotated Cluster. For example:
  ```yaml
  loft.sh/agent-values: |
    replicaCount: 2
    resources:
      limits:
        memory: 2Gi
  ```
### Override values
When installing the agent directly on a host cluster, you can override values by passing a custom values file to Helm. But first, you should tell vCluster Platform to ignore the agent of the specific cluster by adding annotation:
  ```
  kubectl annotate cluster cluster-B loft.sh/cluster-ignore-agent="true"
  ```
  Then you can set the values through the `--values` flag:
  ```bash
  helm install vcluster-platform vcluster-platform \
    --set agentOnly=true \
    --values custom-values.yaml
  ```
  This approach allows full control over agent configuration at installation time for that specific host cluster.

  You can also update the agent settings in vCluster Platform UI.
  <Flow id="cluster-extravalues-vcluster-platform-agent">
    <Step>
      Go to the <NavStep>Clusters</NavStep> view using the menu on the left.
    </Step>
    <Step>
      Click the drop down arrow next to the cluster name you wish to modify. In
      the drop down menu click the <Label>Edit</Label> button.
    </Step>
    <Step>
      In the drawer that appears from the right, click on the <Label>Agent</Label>{" "}
      configuration pane. Provide the values in the textarea under{" "}
      <Label>Extra Agent Values</Label> in the YAML format.
    </Step>
    <Step>
      Click on the <Button>Save Changes</Button> button.
    </Step>
  </Flow>

## Finding Agent Pods

The platform agent runs as a pod in each connected cluster. Locate agent pods to verify connectivity and troubleshoot issues:

<InterpolatedCodeBlock
  code={`kubectl get pods -n [[VAR:MANAGEMENT_NAMESPACE:vcluster-platform]] -l app=loft`}
  language="bash"
  title="List agent pods"
/>

Example output:
```
NAME                   READY   STATUS    RESTARTS   AGE
loft-d6c6d5576-7kqwx   1/1     Running   0          9d
```

## Retrieve agent values

For a platform instance on host `nimbus.vcluster.cloud` with a connected cluster named `staging`, the following table shows how to retrieve agent values for each tier. Use these endpoints to determine current agent configuration or to layer values instead of overriding them.

You can specify multiple values files:
```bash
--values=https://<platform-config-endpoint> --values=https://<cluster-annotation-endpoint>
```
An [access key](/platform/administer/users-permissions/access-keys#how-access-keys-work) is required for authentication.
<br></br>

<!-- vale off -->
| Host                    | Cluster Name | Source            | Request                                                                                     | Response                                            |
|-------------------------|-----------|----------------------|---------------------------------------------------------------------------------------------|-----------------------------------------------------|
| `nimbus.vcluster.cloud` | `staging` | none                 | `https://nimbus.vcluster.cloud/clusters/staging?token=access-key`                           | Current agent values                                |
| `nimbus.vcluster.cloud` | `staging` | `platform-config`    | `https://nimbus.vcluster.cloud/clusters/staging?token=access-key&source=platform-config`    | Content of `agentValues` section in platform config |
| `nimbus.vcluster.cloud` | `staging` | `cluster-annotation` | `https://nimbus.vcluster.cloud/clusters/staging?token=access-key&source=cluster-annotation` | Value of the `loft.sh/agent-values` annotation on the `Cluster Object` |
<!-- vale on -->