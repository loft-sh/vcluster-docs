[build]
base = "/"
publish = "public/"
command = """
    set -e
    echo "NODE_OPTIONS: $NODE_OPTIONS"
    node --version
    node -e "console.log('Heap limit:', require('v8').getHeapStatistics().heap_size_limit / 1024 / 1024 / 1024, 'GB')"
    mkdir -p public/
    npm run build
    mv build/ public/docs/
  """

[build.environment]
  NODE_VERSION = "20"
  NODE_OPTIONS = "--max-old-space-size=8192"

[build.processing]
  skip = false

[build.processing.html]
  pretty_urls = true

# Redirects - Order matters (first match wins)
# Specific paths before wildcards, /next/ stays in /next/

# Legacy paths
[[redirects]]
  from = "/docs/architecture/*"
  to = "/docs/vcluster/introduction/architecture/"

[[redirects]]
  from = "/docs/cli/*"
  to = "https://www.vcluster.com/docs/vcluster/cli/:splat"

[[redirects]]
  from = "/docs/deploying-vclusters/*"
  to = "https://www.vcluster.com/docs/vcluster/deploy/control-plane/container/basics/:splat"

[[redirects]]
  from = "/docs/get-started"
  to = "/docs/vcluster/introduction/what-are-virtual-clusters"

[[redirects]]
  from = "/docs/getting-started/*"
  to = "/docs/vcluster/"

[[redirects]]
  from = "/docs/networking/*"
  to = "https://www.vcluster.com/docs/vcluster/configure/vcluster-yaml/networking/:splat"

[[redirects]]
  from = "/docs/security/*"
  to = "https://www.vcluster.com/docs/platform/understand/what-are-virtual-clusters#robust-security-and-isolation"

[[redirects]]
  from = "/docs/syncer/*"
  to = "https://www.vcluster.com/docs/vcluster/0.20.0/introduction/architecture#syncer"

[[redirects]]
  from = "/docs/using-vclusters/*"
  to = "https://www.vcluster.com/docs/vcluster/introduction/what-are-virtual-clusters#common-use-cases"

[[redirects]]
  from = "/docs/config-reference/"
  to = "/docs/vcluster/vcluster-yaml/"

[[redirects]]
  from = "/docs/storage/"
  to = "https://www.vcluster.com/docs/vcluster/category/storage"

[[redirects]]
  from = "/docs/what-are-virtual-clusters/"
  to = "https://www.vcluster.com/docs/vcluster/introduction/what-are-virtual-clusters"

[[redirects]]
  from = "/docs/help&tutorials/*"
  to = "https://www.vcluster.com/docs/vcluster/"

### Permalinks for the platform UI.
## The purpose of this is to keep the platform resilient against changes in the docs,
## such that we can fix routing of docs links here, rather than requiring customers
## to update to a new version.

## CRDs

# Project
[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/project"
  to = "/docs/platform/api/resources/project"

[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/project/:version"
  to = "/docs/platform/:version/api/resources/project"

# Project Secret
[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/projectsecret"
  to = "/docs/platform/administer/secrets/project/create"

[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/projectsecret/:version"
  to = "/docs/platform/:version/administer/secrets/project/create"

# Understanding Secrets
[[redirects]]
  from = "/docs/platform-ui-link/platform/what-are-secrets"
  to = "/docs/platform/understand/what-are-secrets"

[[redirects]]
  from = "/docs/platform-ui-link/platform/what-are-secrets/:version"
  to = "/docs/platform/:version/understand/what-are-secrets"

# Team
[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/team"
  to = "/docs/platform/api/resources/team"

[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/team/:version"
  to = "/docs/platform/:version/api/resources/team"

# User
[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/user"
  to = "/docs/platform/api/resources/user"

[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/user/:version"
  to = "/docs/platform/:version/api/resources/user"

# Cluster Role Template
[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/clusterroletemplate"
  to = "/docs/platform/api/resources/clusterroletemplate"

[[redirects]]
  from = "/docs/platform-ui-link/platform/crd/clusterroletemplate/:version"
  to = "/docs/platform/:version/api/resources/clusterroletemplate"

# Owned Access Key
[[redirects]]
from = "/docs/platform-ui-link/platform/crd/ownedaccesskey"
to = "/docs/platform/api/resources/ownedaccesskey"

[[redirects]]
from = "/docs/platform-ui-link/platform/crd/ownedaccesskey/:version"
to = "/docs/platform/:version/api/resources/ownedaccesskey"

## Misc. platform links

# Database connector
[[redirects]]
from = "/docs/platform-ui-link/platform/database-connector"
to = "/docs/platform/administer/connector/database"

[[redirects]]
from = "/docs/platform-ui-link/platform/database-connector/:version"
to = "/docs/platform/:version/administer/connector/database"

# Permissions overview
[[redirects]]
from = "/docs/platform-ui-link/platform/permissions-overview"
to = "/docs/platform/administer/users-permissions/overview"

[[redirects]]
from = "/docs/platform-ui-link/platform/permissions-overview/:version"
to = "/docs/platform/:version/administer/users-permissions/overview"

# OIDC tutorial
[[redirects]]
  from = "/docs/platform-ui-link/platform/how-to-oidc-provider"
  to = "/docs/platform/how-to/oidc-provider"

[[redirects]]
  from = "/docs/platform-ui-link/platform/how-to-oidc-provider/:version"
  to = "/docs/platform/:version/how-to/oidc-provider"

# Sleep mode tutorial
[[redirects]]
  from = "/docs/platform-ui-link/platform/working-with-sleep-mode"
  to = "/docs/platform/use-platform/virtual-clusters/key-features/sleep-mode#working-with-sleep-mode"

[[redirects]]
  from = "/docs/platform-ui-link/platform/working-with-sleep-mode/:version"
  to = "/docs/platform/:version/use-platform/virtual-clusters/key-features/sleep-mode#working-with-sleep-mode"

# Config
[[redirects]]
  from = "/docs/platform-ui-link/platform/config"
  to = "/docs/platform/configure/config"

[[redirects]]
  from = "/docs/platform-ui-link/platform/config/:version"
  to = "/docs/platform/:version/configure/config"

# Quick Start Guide / vCluster CLI
[[redirects]]
  from = "/docs/platform-ui-link/platform/quick-start-guide"
  to = "/docs/platform/install/quick-start-guide"

[[redirects]]
  from = "/docs/platform-ui-link/platform/quick-start-guide/:version"
  to = "/docs/platform/:version/install/quick-start-guide"

# karpenter integration
[[redirects]]
  from = "/docs/platform-ui-link/platform/karpenter-integration"
  to = "/docs/platform/integrations/karpenter"

[[redirects]]
  from = "/docs/platform-ui-link/platform/karpenter-integration/:version"
  to = "/docs/platform/:version/integrations/karpenter"

# Parameters
[[redirects]]
  from = "/docs/platform-ui-link/platform/template-parameters"
  to = "/docs/platform/administer/templates/parameters"

[[redirects]]
  from = "/docs/platform-ui-link/platform/template-parameters/:version"
  to = "/docs/platform/:version/administer/templates/parameters"

# Sleep Mode
[[redirects]]
  from = "/docs/platform-ui-link/platform/sleep-mode"
  to = "/docs/platform/use-platform/virtual-clusters/key-features/sleep-mode"

[[redirects]]
  from = "/docs/platform-ui-link/platform/sleep-mode/:version"
  to = "/docs/platform/:version/use-platform/virtual-clusters/key-features/sleep-mode"

# Connect cluster
[[redirects]]
  from = "/docs/platform-ui-link/platform/connect-cluster"
  to = "/docs/platform/administer/clusters/connect-cluster"

[[redirects]]
  from = "/docs/platform-ui-link/platform/connect-cluster/:version"
  to = "/docs/platform/:version/administer/clusters/connect-cluster"

# Project quotas
[[redirects]]
  from = "/docs/platform-ui-link/platform/project-quotas"
  to ="/docs/platform/administer/projects/quotas"

[[redirects]]
  from = "/docs/platform-ui-link/platform/project-quotas/:version"
  to = "/docs/platform/:version/administer/projects/quotas"

# Node Types Overview
[[redirects]]
  from = "/docs/platform-ui-link/platform/node-types-overview"
  to = "/docs/platform/administer/node-providers/overview#node-types"

[[redirects]]
  from = "/docs/platform-ui-link/platform/node-types-overview/:version"
  to = "/docs/platform/:version/administer/node-providers/overview#node-types"

# Node Type Properties
[[redirects]]
  from = "/docs/platform-ui-link/platform/node-type-properties"
  to = "/docs/platform/administer/node-providers/overview#properties"

[[redirects]]
  from = "/docs/platform-ui-link/platform/node-type-properties/:version"
  to = "/docs/platform/:version/administer/node-providers/overview#properties"

# Node Type Cost
[[redirects]]
  from = "/docs/platform-ui-link/platform/node-type-cost"
  to = "/docs/platform/administer/node-providers/overview#cost"

[[redirects]]
  from = "/docs/platform-ui-link/platform/node-type-cost/:version"
  to = "/docs/platform/:version/administer/node-providers/overview#cost"

# Node Providers Overview
[[redirects]]
  from = "/docs/platform-ui-link/platform/node-providers-overview"
  to = "/docs/platform/administer/node-providers/overview"

[[redirects]]
  from = "/docs/platform-ui-link/platform/node-providers-overview/:version"
  to = "/docs/platform/:version/administer/node-providers/overview"

# Terraform Env Template
[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-env-template"
  to = "/docs/platform/administer/node-providers/terraform#node-environment-template"

[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-env-template/:version"
  to = "/docs/platform/:version/administer/node-providers/terraform#node-environment-template"

# Terraform Node Templates
[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-node-templates"
  to = "/docs/platform/administer/node-providers/terraform#node-templates"

[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-node-templates/:version"
  to = "/docs/platform/:version/administer/node-providers/terraform#node-templates"

# Terraform Inline Templates
[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-inline-templates"
  to = "/docs/platform/administer/node-providers/terraform#use-inline"

[[redirects]]
  from = "/docs/platform-ui-link/platform/terraform-inline-templates/:version"
  to = "/docs/platform/:version/administer/node-providers/terraform#use-inline"

# BCM Credentials
[[redirects]]
  from = "/docs/platform-ui-link/platform/bcm-credentials"
  to = "/docs/platform/administer/node-providers/bcm#create-secret-with-bcm-credentials"

[[redirects]]
  from = "/docs/platform-ui-link/platform/bcm-credentials/:version"
  to = "/docs/platform/:version/administer/node-providers/bcm#create-secret-with-bcm-credentials"

# Node Claims
[[redirects]]
  from = "/docs/platform-ui-link/platform/node-claims"
  to = "/docs/platform/administer/node-providers/overview#node-claims"

[[redirects]]
  from = "/docs/platform-ui-link/platform/node-claims/:version"
  to = "/docs/platform/:version/administer/node-providers/overview#node-claims"

## Misc. vCluster links

# Migrate vCluster configuration / Backup and Restore
[[redirects]]
from = "/docs/platform-ui-link/vcluster/backup-restore-migration"
to = "/docs/vcluster/manage/backup-restore#migrate-and-override-vcluster-configuration-options-to-create-a-new-vcluster"

[[redirects]]
from = "/docs/platform-ui-link/vcluster/backup-restore-migration/:version"
to = "/docs/vcluster/:version/manage/backup-restore#migrate-and-override-vcluster-configuration-options-to-create-a-new-vcluster"

# Supported Migration Options / Backup and Restore
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/supported-migration-options"
  to = "/docs/vcluster/manage/backup-restore#supported-migration-options"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/supported-migration-options/:version"
  to = "/docs/vcluster/:version/manage/backup-restore#supported-migration-options"

# Control Plane
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/control-plane"
  to = "/docs/vcluster/category/components"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/control-plane/:version"
  to = "/docs/vcluster/:version/category/components"

# Control Plane > Backing Store
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/backing-store"
  to = "/docs/vcluster/configure/vcluster-yaml/control-plane/components/backing-store/"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/backing-store/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/control-plane/components/backing-store/"

# Control Plane > Distro
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/control-plane-distro"
  to = "/docs/vcluster/configure/vcluster-yaml/control-plane/components/distro/"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/control-plane-distro/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/control-plane/components/distro/"

# Resource quota
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/resource-quota"
  to = "/docs/vcluster/configure/vcluster-yaml/policies/resource-quota"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/resource-quota/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/policies/resource-quota"

# 0.20 migration
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/0-20-migration"
  to = "/docs/vcluster/reference/migrations/0-20-migration"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/0-20-migration/:version"
  to = "/docs/vcluster/:version/reference/migrations/0-20-migration"

# Sync from host
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/sync-from-host"
  to = "/docs/vcluster/configure/vcluster-yaml/sync/from-host/"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/sync-from-host/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/sync/from-host/"

# Sync from host > Nodes
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/nodes"
  to = "/docs/vcluster/configure/vcluster-yaml/sync/from-host/nodes"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/nodes/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/sync/from-host/nodes"

# Sync to host
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/sync-to-host"
  to = "/docs/vcluster/configure/vcluster-yaml/sync/to-host/"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/sync-to-host/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/sync/to-host/"

# Hybrid scheduling
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/hybrid-scheduling"
  to = "/docs/vcluster/configure/vcluster-yaml/sync/to-host/core/pods/hybrid-scheduling"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/hybrid-scheduling/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/sync/to-host/core/pods/hybrid-scheduling"

# Private nodes
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes"
  to = "/docs/vcluster/deploy/worker-nodes/private-nodes"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes/:version"
  to = "/docs/vcluster/:version/deploy/worker-nodes/private-nodes"

# Private nodes - node requirements
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-node-requirements"
  to = "/docs/vcluster/deploy/worker-nodes/private-nodes/node-requirements"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-node-requirements/:version"
  to = "/docs/vcluster/:version/deploy/worker-nodes/private-nodes/node-requirements"

# Private nodes - auto nodes
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-auto-nodes"
  to = "/docs/vcluster/configure/vcluster-yaml/private-nodes/auto-nodes"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-auto-nodes/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/private-nodes/auto-nodes"

# Private nodes - auto nodes requirements
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-auto-nodes-requirements"
  to = "/docs/vcluster/configure/vcluster-yaml/private-nodes/auto-nodes/#requirements"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/private-nodes-auto-nodes-requirements/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/private-nodes/auto-nodes/#requirements"

# vcluster.yaml
[[redirects]]
  from = "/docs/platform-ui-link/vcluster/vcluster-yaml"
  to = "/docs/vcluster/configure/vcluster-yaml/"

[[redirects]]
  from = "/docs/platform-ui-link/vcluster/vcluster-yaml/:version"
  to = "/docs/vcluster/:version/configure/vcluster-yaml/"

[[redirects]]
  from = "/docs/deploy/control-plane/*"
  to = "/docs/vcluster/deploy/control-plane/:splat"
  status = 301

[[redirects]]
  from = "/docs/deploy/*"
  to = "/docs/vcluster/deploy/:splat"
  status = 301


[[redirects]]
  from = "/docs/vcluster/0.27.0/*"
  to = "/docs/vcluster/:splat"
  status = 301
  force = true

[[redirects]]
  from = "/docs/platform/4.3.0/*"
  to = "/docs/platform/:splat"
  status = 301
  force = true

# =====================================================
# vCluster v0.27 Documentation Restructure Redirects
# =====================================================

# learn-how-to/* -> learn-how-to/control-plane/container/*
[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/capture-pprof-vcluster"
  to = "/docs/vcluster/:splat/learn-how-to/control-plane/container/capture-pprof-vcluster"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/check-vcluster"
  to = "/docs/vcluster/:splat/learn-how-to/control-plane/container/check-vcluster"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/configure-custom-coredns"
  to = "/docs/vcluster/:splat/learn-how-to/control-plane/container/configure-custom-coredns"
  status = 301

[[redirects]]
  from = "/docs/vcluster/learn-how-to/enable-debug-logging"
  to = "/docs/vcluster/learn-how-to/control-plane/container/enable-debug-logging"
  status = 301

[[redirects]]
  from = "/docs/vcluster/next/learn-how-to/enable-debug-logging"
  to = "/docs/vcluster/next/learn-how-to/control-plane/container/enable-debug-logging"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/override-alpine-sidecar"
  to = "/docs/vcluster/:splat/learn-how-to/control-plane/container/override-alpine-sidecar"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/retrieve-vcluster-config"
  to = "/docs/vcluster/:splat/learn-how-to/control-plane/container/retrieve-vcluster-config"
  status = 301

# kai-scheduler -> third-party-integrations/scheduler/kai-scheduler
[[redirects]]
  from = "/docs/vcluster/next/learn-how-to/configure-kai-scheduler/"
  to = "/docs/vcluster/next/third-party-integrations/scheduler/kai-scheduler/"
  status = 301

[[redirects]]
  from = "/docs/vcluster/next/learn-how-to/configure-kai-scheduler"
  to = "/docs/vcluster/next/third-party-integrations/scheduler/kai-scheduler"
  status = 301

[[redirects]]
  from = "/docs/vcluster/learn-how-to/configure-kai-scheduler/"
  to = "/docs/vcluster/third-party-integrations/scheduler/kai-scheduler/"
  status = 301

[[redirects]]
  from = "/docs/vcluster/learn-how-to/configure-kai-scheduler"
  to = "/docs/vcluster/third-party-integrations/scheduler/kai-scheduler"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/configure-kai-scheduler"
  to = "/docs/vcluster/:splat/third-party-integrations/scheduler/kai-scheduler"
  status = 301

# control-node-ip-visibility -> worker-nodes/host-nodes/control-node-ip-visibility
[[redirects]]
  from = "/docs/vcluster/next/learn-how-to/control-node-ip-visibility"
  to = "/docs/vcluster/next/learn-how-to/worker-nodes/host-nodes/control-node-ip-visibility"
  status = 301

[[redirects]]
  from = "/docs/vcluster/learn-how-to/control-node-ip-visibility"
  to = "/docs/vcluster/learn-how-to/worker-nodes/host-nodes/control-node-ip-visibility"
  status = 301

[[redirects]]
  from = "/docs/vcluster/*/learn-how-to/control-node-ip-visibility"
  to = "/docs/vcluster/:splat/learn-how-to/worker-nodes/host-nodes/control-node-ip-visibility"
  status = 301

# integrations/* -> third-party-integrations/*
[[redirects]]
  from = "/docs/vcluster/next/integrations/*"
  to = "/docs/vcluster/next/third-party-integrations/:splat"
  status = 301

[[redirects]]
  from = "/docs/vcluster/integrations/*"
  to = "/docs/vcluster/third-party-integrations/:splat"
  status = 301

[[redirects]]
  from = "/docs/vcluster/:version/integrations/pod-identity/:file"
  to = "/docs/vcluster/:version/third-party-integrations/pod-identity/:file"
  status = 301

[[redirects]]
  from = "/docs/vcluster/:version/integrations/external-secrets/:file"
  to = "/docs/vcluster/:version/third-party-integrations/external-secrets/:file"
  status = 301

[[redirects]]
  from = "/docs/vcluster/:version/integrations/github-actions/:file"
  to = "/docs/vcluster/:version/third-party-integrations/github-actions/:file"
  status = 301

[[redirects]]
  from = "/docs/vcluster/:version/integrations/metrics/:file"
  to = "/docs/vcluster/:version/third-party-integrations/metrics/:file"
  status = 301

[[redirects]]
  from = "/docs/vcluster/:version/integrations/:path"
  to = "/docs/vcluster/:version/third-party-integrations/:path"
  status = 301

# deploy/environment/* -> deploy/control-plane/container/environment/*
[[redirects]]
  from = "/docs/vcluster/next/deploy/environment/*"
  to = "/docs/vcluster/next/deploy/control-plane/container/environment/:splat"
  status = 301

[[redirects]]
  from = "/docs/vcluster/deploy/environment/*"
  to = "/docs/vcluster/deploy/control-plane/container/environment/:splat"
  status = 301

# deploy/topologies/* -> deploy/control-plane/container/*
[[redirects]]
  from = "/docs/vcluster/next/deploy/topologies/*"
  to = "/docs/vcluster/next/deploy/control-plane/container/:splat"
  status = 301

[[redirects]]
  from = "/docs/vcluster/deploy/topologies/*"
  to = "/docs/vcluster/deploy/control-plane/container/:splat"
  status = 301

# deploy/basics -> deploy/control-plane/container/basics
[[redirects]]
  from = "/docs/vcluster/next/deploy/basics"
  to = "/docs/vcluster/next/deploy/control-plane/container/basics"
  status = 301

[[redirects]]
  from = "/docs/vcluster/deploy/basics"
  to = "/docs/vcluster/deploy/control-plane/container/basics"
  status = 301