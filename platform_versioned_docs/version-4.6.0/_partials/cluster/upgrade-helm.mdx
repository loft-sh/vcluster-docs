import Flow, { Step } from '@site/src/components/Flow'
import NavStep from '@site/src/components/NavStep'
import Button from '@site/src/components/Button'
import Label from '@site/src/components/Label'
import Input from '@site/src/components/Input'
import Expander from '@site/src/components/Expander'

<Flow id="upgrade-cluster-helm">
    <Step>
        If you prefer to use Helm, ensure that you have a valid access key. You can only obtain an access key after the cluster has been connected to the Platform.
    </Step>
    <Step>
        To retrieve the access key for a connected cluster, run:

        ```bash
        vcluster platform get cluster-access-key cluster-name
        ```
        
        The expected output is:
        
        ```bash
        14:43:35 info vCluster platform host: https://loftg2fei.loft.host
        14:43:35 info Access Key: xxxxxxxx
        ```
        In this example, `cluster-name` refers to the host cluster containing the [vCluster Platform Agent](/docs/platform/administer/clusters/advanced/agent-config) to be upgraded.

        <!-- vale off -->
        Here, `https://loftg2fei.loft.host` represents the `url`, and `xxxxxxxx` is the `token`.
        <!-- vale on -->
    </Step>
    <Step>
        Next, use the following Helm command to upgrade the platform agent by providing the retrieved `url` and `token`:
        
        ```yaml
        helm upgrade loft vcluster-platform \
            --repo https://charts.loft.sh \
            --install \
            --create-namespace \
            --namespace vcluster-platform \
            --set agentOnly=true \
            --set url=https://loftg2fei.loft.host \
            --set token=xxxxxxxx
        ```   
        Ensure that the namespace specified with `--namespace` exists. This is the namespace where the platform agent is installed.
        If you deploy the platform agent’s resources into a different namespace, make sure to set `--namespace` accordingly.

        You can also retrieve pre-configured agent values from your platform by appending the `--values` flag with platform endpoint
        `--values "https://$HOST/clusters/agent-values/$CLUSTER_NAME?token=$TOKEN"`.
        - `$HOST` — your platform domain.
        - `$CLUSTER_NAME` — the name of the cluster you are connecting.
        - `$TOKEN` — the authentication token.
        In this example, `$HOST=loftg2fei.loft.host`, `$CLUSTER_NAME=cluster-name` and `$TOKEN=xxxxxxxx`.
        The endpoint returns a YAML file with agent values that are configured in the `agentValues` field of your vCluster 
        Platform Helm values, merged with any cluster-specific overrides from the `loft.sh/agent-values` annotation (when present).

        If the platform agent is not yet installed, you can include the `--install` and `--create-namespace` flags. The combination 
        of `--create-namespace` and `--namespace vcluster-platform` will create the `vcluster-platform` namespace in the host cluster
        if it does not already exist. All platform agent resources will then be deployed and run within that namespace.
    </Step>
</Flow>