---
title: Snapshot and Restore
sidebar_label: Snapshot and Restore
sidebar_position: 3
---

There are multiple ways to back up and restore a virtual cluster. vCluster provides a built-in method to create and restore snapshots using its CLI.

:::warning
If you use an external database, such as MySQL or PostgreSQL, that does **not** run in the same namespace as vCluster, you must create a separate backup for the datastore. For more information, refer to the relevant database documentation.  
:::

## Use the vCluster CLI

:::info
This method requires vCluster version v0.24.0 or higher
:::

The vCluster CLI is the recommended way to back up the etcd datastore. When you run a backup, vCluster creates a temporary pod to save the snapshot at the specified location and automatically determines the configured backing store. The snapshot includes:

- Backing store data (for example, etcd or SQLite)
- vCluster Helm release information
- vCluster configuration (for example, `vcluster.yaml`)


:::info
The vCluster CLI backup method currently does not support backing up persistent volumes. To back up persistent volumes, use the [Velero backup method](#use-velero).
:::

### Snapshot URL

vCluster uses a snapshot URL to save the snapshot to a specific location. The snapshot URL contains the following information:

| Parameter          | Description | Example |
|--------------------|-------------|---------|
| Protocol           | Defines the storage type for the snapshot | `oci`, `s3`, `container` |
| Storage location   | Specifies where to save the snapshot | `oci://ghcr.io/my-user/my-repo:my-tag`, `s3://my-s3-bucket/my-snapshot-key`, `container:///data/my-snapshot.tar.gz` |
| Optional flags     | Additional options for snapshot storage | `skip-client-credentials=true` |

### Supported protocols

The following protocols are supported for storing snapshots:

- [`oci`](#oci) – Stores snapshots in an OCI image registry, such as Docker Hub or GHCR.
- [`s3`](#s3) – Saves snapshots to an S3-compatible bucket, such as AWS S3 or MinIO.
- [`container`](#container) – Stores snapshots as a local file inside a persistent volume claim (PVC).

For example, the following snapshot URL saves the snapshot to an OCI image registry:

```bash
vcluster snapshot my-vcluster "oci://ghcr.io/my-user/my-repo:my-tag"
```

#### `oci`

Use the following flags with the `oci` protocol when saving snapshots to an OCI-compliant image registry:

| Flag                      | Description |
|---------------------------|-------------|
| `username`                | Username used to authenticate with the OCI image registry |
| `password`                | Base64-encoded password used to authenticate with the OCI image registry |
| `skip-client-credentials` | Skips use of local credentials for authentication |

### Save a vCluster snapshot to an OCI image registry

Use the following command to create a snapshot and push it to an OCI-compliant image registry, such as Docker Hub or GHCR:

```bash
vcluster snapshot my-vcluster "oci://ghcr.io/my-user/my-repo:my-tag"
```

#### `s3`

You can store snapshots in an S3-compatible bucket using the `s3` protocol. The following flags are supported:

| Flag                        | Description |
|-----------------------------|-------------|
| `access-key-id`             | Base64-encoded S3 access key ID for authentication |
| `secret-access-key`         | Base64-encoded S3 secret access key for authentication |
| `session-token`             | Base64-encoded temporary session token for authentication |
| `region`                    | Region of the S3-compatible bucket |
| `profile`                   | AWS profile to use for authentication |
| `skip-client-credentials`   | Skips use of local credentials for authentication |


#### Save a snapshot to an S3-compatible bucket

Run the following command to create a snapshot and store it in an S3-compatible bucket, such as AWS S3 or MinIO:

```bash
vcluster snapshot my-vcluster "s3://my-s3-bucket/my-bucket-key"


 # with custom credetials
 export ACCESS_KEY_ID=$(cat my-access-key-id.txt | base64)
 export SECRET_ACCESS_KEY=$(cat my-secret-access-key.txt | base64)
 export SESSION_TOKEN=$(cat my-session-token.txt | base64)
 vcluster snapshot my-vcluster "s3://my-s3-bucket/my-bucket-key?access-key-id=$ACCESS_KEY_ID&secret-access-key=$SECRET_ACCESS_KEY&session-token=$SESSION_TOKEN"
```

#### `container`

Use the `container` protocol to save snapshots as local files in a PVC.

##### Save a snapshot inside the container

Run the following command to create a snapshot and store it in the specified path inside a container:

```bash
vcluster snapshot my-vcluster "container:///data/my-snapshot.tar.gz"
```

### Create a snapshot

You can create a snapshot using the following commands:

#### oci

```bash
# Create an OCI snapshot (use local credentials)
vcluster snapshot my-vcluster "oci://ghcr.io/my-user/my-repo:my-tag"

# Create an OCI snapshot and mount an external image pull secret
vcluster snapshot my-vcluster "oci://ghcr.io/my-user/my-repo:my-tag?skip-client-credentials=true" --pod-image-pull-secret=my-image-pull-secret
```

#### s3

```bash
# Create an s3 snapshot
vcluster snapshot my-vcluster "s3://my-s3-bucket/my-snapshot-key"
```

#### container

```bash
# Create a snapshot to local vCluster pvc (if using embedded storage)
vcluster snapshot my-vcluster "container:///data/my-snapshot.tar.gz"

# Create a snapshot to another PVC (needs to be in the same namespace as vCluster)
vcluster snapshot my-vcluster "container:///my-pvc/my-snapshot.tar.gz" --pod-mount "pvc:my-pvc:/my-pvc"
```

Each snapshot command creates a new pod (using the vCluster image) to back up the backing store. To run the snapshot process inside an existing pod using `kubectl exec`, add the `--pod-exec` flag instead of launching a separate pod.

<br /> 

### Restore from a snapshot

Restoring from a snapshot pauses the vCluster, stops all workload pods, and launches a temporary restore pod. Once the restore completes, the vCluster resumes, and workload pods are recreated. This process may result in temporary downtime while the restore is in progress.

You can restore a vCluster using the following commands:

```bash
# Restore from an OCI snapshot (use local credentials)
vcluster restore my-vcluster oci://ghcr.io/my-user/my-repo:my-tag

# Restore from an s3 snapshot
vcluster restore my-vcluster s3://my-s3-bucket/my-snapshot-key

# Restore from a local pvc snapshot (if using embedded storage)
vcluster restore my-vcluster container:///data/my-snapshot.tar.gz
```

:::tip
You can also use snapshots to clone a vCluster or migrate it to a new cluster.
:::

When creating a new vCluster, you can restore it directly from a snapshot:

```bash
# Restore a new vCluster from an OCI snapshot (uses local credentials)
vcluster create my-vcluster --restore oci://ghcr.io/my-user/my-repo:my-tag

# Migrate an existing vCluster by restoring from a snapshot and applying a new vcluster.yaml
vcluster create my-vcluster --upgrade -f vcluster.yaml --restore oci://ghcr.io/my-user/my-repo:my-tag
```

If a restore fails:
- When using `vcluster create`, the vCluster is automatically deleted.
- When using `vcluster restore`, the restore process is aborted. You must retry the restore to avoid leaving the vCluster in an inconsistent or broken state.


### Limitations

The vCluster CLI has the following limitations when backing up and restoring a vCluster:

- The vCluster CLI does not support backing up persistent volumes (PVs) or persistent volume claims (PVCs).
- Snapshotting a k0s-based vCluster requires the `--pod-exec` flag.
- Restoring a vCluster running the k0s distribution is not supported.
- When restoring a vCluster that uses an external database backend, the database is not truncated before the snapshot is restored. Manual cleanup may be required.
- Restoring a vCluster to a different namespace or with a different name changes the vCluster certificates. This prevents multiple vClusters from sharing the same certificates, which is expected behavior.

<br />

## Use Velero

You can use [Velero](https://velero.io/) to back up virtual clusters.

Make sure your cluster supports [volume snapshots](https://kubernetes.io/docs/concepts/storage/volume-snapshots/) to allow Velero to backup persistent volumes and persistent volume claims that save the virtual cluster state. Alternatively, you can use [Velero's restic integration](https://velero.io/docs/main/restic/) to back up the virtual cluster state.

### Back up a vCluster

Install the [Velero CLI](https://velero.io/docs/main/basic-install/), [Velero server components](https://velero.io/docs/v1.8/supported-providers/) and run the following command:

```bash
velero backup create <backup-name> --include-namespaces=my-vcluster-namespace
```

Verify a backup was successfully created with the following command:

```bash
velero backup describe <backup-name>
```

This should create an output similar to the following:

```bash
Name:         <backup-name>
Namespace:    velero
Labels:       velero.io/storage-location=default
Annotations:  velero.io/source-cluster-k8s-gitversion=v1.24.0
              velero.io/source-cluster-k8s-major-version=1
              velero.io/source-cluster-k8s-minor-version=24

Phase:  Completed

Errors:    0
Warnings:  0

Namespaces:
  Included:  test
  Excluded:  <none>

Resources:
  Included:        *
  Excluded:        <none>
  Cluster-scoped:  auto

...
```

### Restore a vCluster

After creating a backup with the Velero CLI or a scheduled backup, you can restore a vCluster using the Velero CLI:

```bash
velero restore create <restore-name> --from-backup <backup-name>
```

Verify the restore process using the following command:

```bash
velero restore logs <restore-name>
```

This restores the vCluster workloads, configuration, and state in the virtual cluster namespace.

:::warning Moving vCluster
Moving a vCluster from one namespace to another can be challenging because some objects, such as cluster role bindings and persistent volumes, contain namespace references. Velero supports namespace mapping, which works in most cases, but use caution—this may not be compatible with all vCluster setups.
:::

### Use Velero inside vCluster

To use Velero for backups, first enable the [hostpath-mapper](/docs/vcluster/configure/vcluster-yaml/control-plane/components/host-path-mapper) component in vCluster.

After enabling hostpath-mapper, install the Velero CLI (as described above), connect to your vCluster, and install Velero inside the virtual cluster:

```bash
velero install --provider <provider> --bucket <bucket_name>  --secret-file <your_secret_file> --plugins velero/velero-plugin-for-<provider>:<semver> --use-restic
```

:::note
Ensure you replace `provider`, `bucket_name`, `secret-file`, and other placeholders with the correct values for your environment.
:::

After installation is complete, you can check the status of the Velero resources:

```bash
$ kubectl get all -n velero
NAME                          READY   STATUS    RESTARTS   AGE
pod/restic-5szkb              1/1     Running   0          118s
pod/velero-75c5479dfd-4x7sl   1/1     Running   0          118s

NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/restic   1         1         1       1            1           <none>          118s

NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/velero   1/1     1            1           119s

NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/velero-75c5479dfd   1         1         1       119s
```

Now you're ready to create a backup using `restic`:
```
velero backup create test1 --default-volumes-to-restic
```

Wait for the backup to complete and eventually you should see the following:
```
$ velero backup describe test1
Name:         test1
Namespace:    velero
Labels:       velero.io/storage-location=default
Annotations:  velero.io/source-cluster-k8s-gitversion=v1.25.0+k3s1
              velero.io/source-cluster-k8s-major-version=1
              velero.io/source-cluster-k8s-minor-version=25

Phase:  Completed

Errors:    0
Warnings:  0

Namespaces:
  Included:  *
  Excluded:  <none>

Resources:
  Included:        *
  Excluded:        <none>
  Cluster-scoped:  auto

...
```

