import Flow, { Step } from '@site/src/components/Flow';

#### S3 configuration options

| Option  | Description  |
|---|---|
| `auto.storage.type.s3.url` | URL of the AWS S3 bucket. Must be pre-fixed with `s3://`.  |
| `auto.storage.type.s3.credential` | References the AWS credentials as a Kubernetes secret |
| `auto.storage.type.s3.credential.name` | Name of the Kubernetes secret. |
| `auto.storage.type.s3.credential.namespace` | Namespace of the Kubernetes secret. The secret must be deployed on the host of where the vCluster control plane pod is deployed to. |

#### Authenticate with AWS Pod identity

When using AWS S3 buckets, it is recommended to authenticate using [AWS pod identity](https://aws.amazon.com/blogs/containers/amazon-eks-pod-identity-a-new-way-for-applications-on-eks-to-obtain-iam-credentials/).

:::info
The EKS Pod Identity association must be created for the vCluster control plane pod. The vCluster control plane pod is the one that runs inside the host cluster namespace automatically created by vCluster Platform for each vClusterâ€”typically named: `loft-<project-name>-<vcluster-name>`. By default, this pod uses the service account: `vc-<vcluster-name>`. This is the service account that must be associated with your EKS Pod Identity role so that the vCluster control plane can authenticate to AWS when performing scheduled snapshot creation to S3.
:::

```yaml title="Example vcluster.yaml configuring snapshots into s3 with a pod identity"
snapshots:
  auto:
    # Take a snapshot every 12 hours
    schedule: 0 */12 * * *
    storage:
      type: s3
        s3:
          # URL of location of S3-compatible bucket
          # Must be prefixed with `s3://`
          url: s3://<bucket-name>/snapshots
```

#### Authenticate with AWS Credentials as a secret

Alternatively, you can create a Kubernetes secret with your AWS credentials.

<Flow>
<Step>
  Create a Kubernetes secret of your AWS credentials.

  Create this secret on the host of where the vCluster control plane is deployed. It could be deployed in the namespace
  of the vCluster or a different namespace. If the vCluster is externally deployed, ensure the vCluster ClusterRole has permission to read the secret. The vCluster ClusterRole follows the naming pattern `vc-<vClusterName>-v-<vClusterNamespace>`.

  The secret needs to contain all these three keys:
  * `AWS_ACCESS_KEY_ID`
  * `AWS_SECRET_ACCESS_KEY`
  * `AWS_SESSION_TOKEN`


  ```bash title="Create AWS credentials secret"
  kubectl create -f - <<EOF
  apiVersion: v1
  kind: Secret
  type: Opaque
  metadata:
    name: aws-cred
    namespace: p-default
  data:
    AWS_ACCESS_KEY_ID: "id"
    AWS_SECRET_ACCESS_KEY: "key"
    AWS_SESSION_TOKEN: "token"
  EOF
  ```
</Step>
<Step>
  Create a vCluster referencing those credentials.

  ```yaml title="Example vcluster.yaml referencing the Kubernetes secret"
  snapshots:
    auto:
      # Take a snapshot every 12 hours
      schedule: 0 */12 * * *
      storage:
        type: s3
        s3:
          # URL of location of S3-compatible bucket
          # Must be prefixed with `s3://`
          url: s3://<bucket-name>/<path>
          # Secret must be located on the host cluster that the vCluster is deployed on
          credential:
            secretName: aws-cred
            secretNamespace: p-default
  ```
</Step>
</Flow>
