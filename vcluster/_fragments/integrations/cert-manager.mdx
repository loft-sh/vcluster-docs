import Flow, { Step } from '@site/src/components/Flow'
import NavStep from '@site/src/components/NavStep'
import Button from '@site/src/components/Button'
import Label from '@site/src/components/Label'
import Field from '@site/src/components/Field'

import CertManagerPartial from '../../_partials/config/integrations/certManager.mdx';

import BasePrerequisites from '../../../platform/_partials/install/base-prerequisites.mdx';

import CodeBlock from '@theme/CodeBlock';

import Deploy from '../../_partials/deploy/deploy.mdx'

import ProAdmonition from '../../_partials/admonitions/pro-admonition.mdx'

<ProAdmonition/>

### Prerequisites

<BasePrerequisites />

- `cert-manager` operator installed on your host cluster. See instructions at https://cert-manager.io

## Cert manager integration

To enable the cert-manager integration, set the following fields as shown below:


```yaml title="Enable cert-manager integration"
integrations:
  certManager:
    enabled: true
```

This configuration enables the integration, imports cluster-scoped ClusterIssuers from the host cluster into the virtual cluster, and exports namespaced Issuers and Certificates from the virtual cluster into the host cluster.

<Flow id="cert-manager-integration">
 <Step>

  Create the Issuer

Create a <Label>file</Label> named `issuer.yaml` with the following content:

```yaml title="ClusterIssuer configuration"
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # highlight-start
    # Replace this email address with your own.
    # Let's Encrypt will use this to contact you about expiring
    # certificates, and issues related to your account.
    # highlight-end
    email: user@example.com
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Secret resource that will be used to store the account's private key.
      name: example-issuer-account-key
    # Add a single challenge solver, HTTP01 using nginx
    solvers:
    - http01:
        ingress:
          ingressClassName: nginx
```

</Step>
<Step>
Apply the Issuer configuration:

```bash title="Apply the Issuer configuration"
kubectl apply -f issuer.yaml
```
:::note
This creates a corresponding Issuer in the host cluster.
:::

</Step>
<Step>

Create and apply Issuer and Certificate

After the virtual cluster is running, create an Issuer and Certificate inside the virtual cluster. This guide uses a `letsencrypt-staging` issuer for demonstration purposes.

</Step>

<Step>
Create the Certificate

Create a file named `certificate.yaml` with the following content:

```yaml title="Certificate configuration"
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: quickstart-example-tls
  namespace: default
spec:
  dnsNames:
  - example.example.com
  issuerRef:
    group: cert-manager.io
    kind: Issuer
    name: letsencrypt-staging
  secretName: quickstart-example-tls
  usages:
  - digital signature
  - key encipherment
```
</Step>
<Step>
Apply the Certificate configuration:

```bash title="Apply the Certificate configuration"
kubectl apply -f certificate.yaml
```

:::tip
After the certificate is created in the virtual cluster, the integration syncs the created secret back to the virtual cluster after the cert-manager operator creates it in the host cluster.
:::

</Step>
</Flow>

## Verify the integration

<Flow id="verify-integration">
  <Step>
Check the status of the Issuer:

   ```bash title="Check Issuer status"
   kubectl describe clusterissuer letsencrypt-staging
   ```
  </Step>

  <Step>
Check the status of the Certificate:

   ```bash title="Check Certificate status"
   kubectl describe certificate quickstart-example-tls
   ```
  </Step>
  <Step>
Verify that the secret containing the certificate has been created:

   ```bash title="Verify secret creation"
   kubectl get secret quickstart-example-tls
   ```
  </Step>
</Flow>


## Using the certificate in an application

To use the created certificate in an application, reference the secret in your Ingress resource:

```yaml title="Example Ingress using the certificate"
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  tls:
  - hosts:
    - example.example.com
    secretName: quickstart-example-tls
  rules:
  - host: example.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: example-service
            port:
              number: 80
```

## Troubleshooting

If you encounter issues with the cert-manager integration, consider the following:

- Ensure that cert-manager is properly installed and running in the host cluster.
- Check the cert-manager logs in the host cluster for any error messages.
- Verify that the Issuer and Certificate resources are correctly configured.
- Ensure that the virtual cluster has the necessary permissions to create and manage certificates.

For more detailed troubleshooting, refer to the [cert-manager troubleshooting guide](https://cert-manager.io/docs/troubleshooting/).

## Config reference

<CertManagerPartial />
