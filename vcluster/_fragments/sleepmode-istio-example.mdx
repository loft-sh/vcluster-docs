import Flow, { Step } from '@site/src/components/Flow';
import CodeBlock from '@theme/CodeBlock'
import SleepmodeIstioConfig from '!!raw-loader!@site/vcluster/configure/vcluster-yaml/_code/sleepmode-istio-config.yaml'
import SleepmodeIstioExample from '!!raw-loader!@site/vcluster/configure/vcluster-yaml/experimental/_code/sleepmode-istio-examples.yaml'

:::info
This example picks up where the [Istio Integration](../vcluster-yaml/integrations/istio) example leaves off.
:::

<Flow id="sleepmode-ingress-example">
  <Step>
    Complete the [Istio Integration](../vcluster-yaml/integrations/istio) example.
  </Step>
  <Step>
    Install the Istio ingress gateway controller to allow routing from outside the cluster.

    Save the following manifest as `ingress.yaml`

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: ingress
spec:
  profile: empty # Do not install CRDs or the control plane
  components:
    ingressGateways:
    - name: istio-ingressgateway
      namespace: istio-ingress
      enabled: true
      label:
        istio: ingressgateway
  values:
    gateways:
      istio-ingressgateway:
        injectionTemplate: gateway
```
    and run
    ```shell
    kubectl create namespace istio-ingress                                                                                                                                        (vcluster_istio-demo_vcluster-istio-demo_orbstack/default)
    istioctl install -f ingress.yaml
    ```
  </Step>

  <Step>
    Create a gateway with a selector for the newly installed Ingress gateway in your vCluster.

```yaml
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: istio-sm-gateway
  namespace: test
spec:
  # The selector matches the ingress gateway pod labels.
  # If you installed Istio using Helm following the standard documentation, this would be "istio=ingress"
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "smdemo.local"

```
  </Step>

  <Step>
    Update the vCluster with sleepMode enabled.

    Use the following `vcluster.yaml` to update your virtual cluster on your host cluster with `--upgrade`.
    Save this file as `vcluster.yaml`

    <CodeBlock title="vCluster config for auto sleep" language="yaml">{SleepmodeIstioConfig}</CodeBlock>
    And run the following command:

    ```bash title="Create vCluster with autoSleep config"
    vcluster create <your-vcluster-name> -f vcluster.yaml --upgrade
    ```
  </Step>

  <Step>
    Enable local DNS resolution for the virtual cluster.

    Add `127.0.0.1 	smdemo.local` to your `/etc/hosts` file to match the host configured in the `Gateway` configuration.
  </Step>

  <Step>
    Update the `VirtualService` from the [Istio Integration](../vcluster-yaml/integrations/istio) by adding the `Gateway`
    from above and the `smdemo.local` host so that it looks like this.

    <CodeBlock title="Example resources" language="yaml">{SleepmodeIstioExample}</CodeBlock>
  </Step>

  <Step>
    Verify the `Gateway` is working properly with `curl`.

    Test the `Gateway` endpoint within the 30-second activity window by running `curl --silent smdemo.local/v1` of `curl --silent smdemo.local/v2`
  </Step>

  <Step>
    Allow the virtual cluster to go to sleep.

    Wait 30 seconds for the cluster to sleep, then run the `curl` command again. For convenience, run `watch -d curl --silent curl --silent smdemo.local/v2` to repeatedly test the endpoint. While asleep, or during wake a `503` will be returned.
  </Step>
</Flow>
