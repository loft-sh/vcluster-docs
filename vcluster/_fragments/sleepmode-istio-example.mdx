import Flow, { Step } from '@site/src/components/Flow';
import CodeBlock from '@theme/CodeBlock'
import SleepmodeIstioConfig from '!!raw-loader!@site/vcluster/configure/vcluster-yaml/_code/sleepmode-istio-config.yaml'
import SleepmodeIstioExample from '!!raw-loader!@site/vcluster/configure/vcluster-yaml/experimental/_code/sleepmode-istio-examples.yaml'

### Configure sleep mode for use with Istio

<Flow id="sleepmode-ingress-example">
  <Step>
Create the `kind` cluster.

```shell title="Create a kind cluster"
kind create cluster --name istio-demo --config - <<EOF
    kind: Cluster
    apiVersion: kind.x-k8s.io/v1alpha4
    nodes:
    - role: control-plane
    extraPortMappings:
    - containerPort: 30000
    listenAddress: 127.0.0.1
    hostPort: 80
    protocol: TCP
    - containerPort: 31000
    listenAddress: 127.0.0.1
    hostPort: 443
    protocol: TCP
    - containerPort: 32000
    listenAddress: 127.0.0.1
    hostPort: 15021
    protocol: TCP
EOF
```
  </Step>
  <Step>
    Install istio

    ```shell title="Install istio"
    istioctl install -y
    ```
  </Step>

  <Step>
Patch the Istio gateway's service to match the ports in the kind configuration.

```shell title="Patch ingress service ports"
kubectl patch service istio-ingressgateway -n istio-system --patch "$(cat <<EOF
spec:
  type: NodePort
  ports:
  - name: http2
    port: 80
    nodePort: 30000
  - name: https
    port: 443
    nodePort: 31000
  - name: status-port
    port: 15021
    targetPort: 15021
    nodePort: 32000
EOF
)"
```
  </Step>

  <Step>
    Create the vCluster.

    Use the following `vcluster.yaml` to create a virtual cluster on your host. Save this file as `vcluster.yaml`

    <CodeBlock title="vCluster config for auto sleep" language="yaml">{SleepmodeIstioConfig}</CodeBlock>
    And run the following command:

    ```bash title="Create vCluster with autoSleep config"
    vcluster create my-vcluster -f vcluster.yaml
    ```
  </Step>

  <Step>
    Enable local DNS resolution for the virtual cluster.

    Add `127.0.0.1 	httpbin.example.com` to your `/etc/hosts` file to match the host configured in the `Gateway` configuration.
  </Step>

  <Step>
    Create resources for the `Ingress` such as a `Deployment` and `Service`.

    Use the following manifest to create:

    - `ServiceAccount`
    - `Service`
    - `Deployment`
    - `Gateway` for `httpbin.example.com`
    - `VirtualService` to route from the above gateway

    <CodeBlock title="Example resources" language="yaml">{SleepmodeIstioExample}</CodeBlock>
  </Step>

  <Step>
    Verify the `Gateway` is working properly with `curl`.

    Test the `Gate` endpoint within the 30-second activity window by running `curl --silent httpbin.example.com/status/418` to see the response "I'm a teapot!"
  </Step>

  <Step>
    Allow the virtual cluster to go to sleep.

    Wait 30 seconds for the cluster to sleep, then run the `curl` command again. For convenience, run `watch -d curl --silent httpbin.example.com/status/418` to repeatedly test the endpoint. While asleep, or during wake a `503` will be returned.
  </Step>
</Flow>
