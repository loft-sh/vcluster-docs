---
title: Deploy in high availability
sidebar_label: High Availability
sidebar_position: 1
---

import WorkerNodeOptions from '../../../../_fragments/deploy/worker-nodes.mdx'
import SecurityOptions from '../../../../_fragments/deploy/security.mdx'
import BackingStoreYAMLOptions from '../../../../_fragments/deploy/backing-store.mdx'

import ProAdmonition from '../../../../_partials/admonitions/pro-admonition.mdx';
import Deploy from '../../../../_partials/deploy/deploy.mdx'

By default, vCluster runs one instance of each of its components. This deployment method is recommended for any uses cases that are very ephemeral (e.g. dev environments, CI/CD, etc.), but for production
use cases, it's recommended to run vCluster with more redundancy. We recommend deploying vCluster in high availability (HA) in order 
to run multiple copies of the vCluster components so that the virtual cluster is more resistant to failures.

## Enabling high availability 

When running vCluster with high availability, the default backing store option (i.e. embedded database) **must be changed** to any of the other [backing store options](../../../../configure/vcluster-yaml/control-plane/components/backing-store). 

### Deployed etcd YAML example

```yaml title="Running in HA with deployed etcd"
controlPlane:
  # Deploy etcd with 3 replicas
  backingStore:
    etcd:
      deploy:
        enabled: true
        statefulSet:
          highAvailability:
            replicas: 3
  # Deploy vCluster with 3 replicas
  statefulSet:
    highAvailability:
      replicas: 3
```

### Embedded etcd YAML example

<ProAdmonition />

```yaml title="Running in HA with embedded etcd"
controlPlane:
  # Deploy etcd with 3 replicas
  backingStore:
    etcd:
      embedded:
        enabled: true
  # Deploy vCluster with 3 replicas
  statefulSet:
    highAvailability:
      replicas: 3
```

## Other predeployment configuration options

Before deploying, it's recommended to review the set of configuration options that cannot be updated post deployment. These options require deploying a new vCluster instead of upgrading your vCluster with new options.

<WorkerNodeOptions />

### Topologies

Decide these topologies for the control plane:

- **[Isolated workloads](./topologies/isolated-workloads)** - Different options to isolate a workload in a vCluster.

<SecurityOptions />
<BackingStoreYAMLOptions />

## Deploy vCluster with HA

:::tip YAML configuration
If you're not sure which options to configure, you can update most settings later by upgrading your vCluster with an updated `vcluster.yaml`.
However, some settings — such as what type of worker nodes or the backing store — can only be set during the initial deployment and cannot be changed during an upgrade.
:::

<Deploy />

## Check the pods of the vCluster on the host cluster

Ensure that your kubecontext is set to the host cluster. 

:::warning 
If you've used the vCluster CLI, your kubecontext automatically switches and connects to the virtual cluster. 
:::

You can get the pods in the namespace of the virtual cluster. The namespace is 
called `vcluster-my-vcluster` in the host cluster, and contains the components of the vCluster. 

```
kubectl get pods -n vcluster-my-vcluster
```

Example using the deployed etcd yaml:

```
NAME                                      READY   STATUS    RESTARTS   AGE
my-vcluster-7c5c5844c5-27j2v              0/1     Running   0          20s
my-vcluster-7c5c5844c5-gb2sm              0/1     Running   0          20s
my-vcluster-7c5c5844c5-pwn7k              0/1     Running   0          20s
my-vcluster-etcd-0                        0/1     Running   0          20s
my-vcluster-etcd-1                        0/1     Running   0          20s
my-vcluster-etcd-2                        0/1     Running   0          20s
```

There are three replicas running of each component (control plane and etcd) of the vCluster. If one API server pod goes down, the vCluster continues working.

In order to see which nodes in the host cluster that these pods were scheduled on, add the `-o wide` flag to the `kubectl get pods` command:

```
kubectl get pods -n vcluster-my-vcluster -o wide
```

The hostnames of the nodes will be listed in the `NODES` column.