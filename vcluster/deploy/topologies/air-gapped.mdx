---
title: Deploy vCluster in an air-gapped environment
sidebar_label: Air-gapped
sidebar_position: 5
description: Learn how to install vCluster in an air-gapped Kubernetes cluster.
sidebar_class_name: pro
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Flow, { Step } from "@site/src/components/Flow";
import BasePrerequisites from '../../../platform/_partials/install/base-prerequisites.mdx';

import FipsConfig from '../../_partials/deploy/fips-config.mdx';

import LicenseKey from '../../_partials/deploy/license_key.mdx';
import ProAdmonition from '../../_partials/admonitions/pro-admonition.mdx';

<!--vale off-->

# Deploy vCluster in an air-gapped environment

<ProAdmonition/>

This document details the prerequisites and steps to install vCluster Pro into
an `air-gapped` Kubernetes cluster without the platform agent running on the host
cluster.

## Overview of artifacts to download

To complete an air-gapped deployment, you'll need:

- The vCluster Helm chart
- The container images required by vCluster

## Prerequisites

<BasePrerequisites />
  - `docker` (check with `docker version`)
  - An offline license key for vCluster Pro (provided by Loft)
    :::info
    <LicenseKey />
    :::
- Optionally: Private docker registry that the installer system and the
air-gapped Kubernetes cluster can access (for example, `x-private-registry:5000` or
`gcr.io/x-team`)
  
  <details>
    <summary>Example local registry setup</summary>

  ### Local Docker registry configuration

    You can set up a private Docker registry for testing with a kind cluster.
    The following steps guide you through configuring a local Docker registry:

  **Basic setup**:
Execute the [setup script](https://kind.sigs.k8s.io/docs/user/local-registry/):

  **Verify and use**:
  ```bash
  # Verify registry
  curl http://localhost:5001/v2/_catalog
  ```
  </details>

## Download vCluster Helm chart

Download the `vCluster` Helm chart from the Loft Helm repository.

:::tip
To retrieve all available versions of the vCluster Helm chart, run the following command:

```bash title="Display the 10 latest vCluster chart versions"
helm repo update
helm search repo loft/vcluster --versions | grep "^loft/vcluster" | head
```
:::

```bash title="Download the vCluster Helm chart"
export CHART_VERSION="0.21.1"  # Replace with the desired version
curl -O https://charts.loft.sh/charts/vcluster-"${CHART_VERSION}".tgz
```

:::info
The `vCluster` Helm chart is a tarball that contains all the necessary images
to deploy the vCluster control plane.
:::

### Option 1: Mirror the Helm repo with a web server

The standard method for installing vCluster is using Helm with the LoftLabs charts repository. For air-gapped environments without internet access, you'll need to host the Helm chart locally. This guide demonstrates how to use a private GitLab instance as a web server to host the vCluster Helm chart.

#### Prerequisites
- A web server accessible through HTTP or HTTPS to store the Helm chart and `index.yaml`.
- A private GitLab instance (used in this example).
- Helm CLI installed.

##### Install with Helm CLI

```bash
helm upgrade --install my-vcluster vcluster \
  --values vcluster.yaml \
  --repo https://your-private-server.com/your-username/your-private-project/path-to-vcluster-chart-directory \
  --version 0.23.0 \
  --namespace my-namespace \
  --repository-config=''
```

#### Download and host the Helm chart

<Flow id="private-web-server">
  <Step>
    Add and update the Loft Helm repository on a machine with internet access:
    
    ```bash
    helm repo add loft https://charts.loft.sh
    helm repo update
    ```
  </Step>
  <Step>
    Download the Helm chart:
    
    ```bash
    helm pull loft/vcluster --version 0.23.0
    ```
  </Step>
  <Step>
    Store the chart on your web server:
    
    ```bash
    git clone <gitlab-repo-url>
    cd <gitlab-repo>
    mkdir vcluster
    mv vcluster-0.23.0.tgz vcluster/
    ```
  </Step>
  <Step>
    Create an `index.yaml` file and push it to the GitLab repository:
    
    ```bash
    helm repo index vcluster --url https://your-private-server.com/your-username/your-private-project/path-to-vcluster-chart
    git add -A
    git commit -m "Add vCluster Helm chart"
    git push
    ```
  </Step>
</Flow>
   :::note 
   Ensure the URL you specify points to the location where `vcluster-0.23.0.tgz` can be accessible to the target cluster.
   :::

### Option 2: Use an OCI-compatible registry

You can use offline Helm Charts.

#### Prerequisites

- OCI-compatible image registry

#### Offline Helm charts

```bash
helm chart save ./vcluster-${CHART_VERSION}.tgz <your-registry>/vcluster:v${CHART_VERSION}
helm chart push <your-registry>/vcluster:v${CHART_VERSION}
```

Then install using:

```bash
helm registry login <your-registry>
helm install vcluster oci://<your-registry>/vcluster --version ${CHART_VERSION}
```

## Download vCluster images

<Flow id="offline-images">
  <Step>
    Set environment variables:
    ```bash
    export VCLUSTER_SERVICE="vcluster"
    export VCLUSTER_NAMESPACE="vcluster"
    export REGISTRY=ecr.io/myteam
    ```
  </Step>
  <Step>
    Retrieve or set the version:
    ```bash
    CHART=$(kubectl get svc ${VCLUSTER_SERVICE} -n ${VCLUSTER_NAMESPACE} -o jsonpath={.metadata.labels.chart})
    export VERSION=${CHART#vcluster-}
    # or manually:
    export VERSION=0.21.1
    ```
  </Step>
  <Step>
    Download artifacts:
    ```bash
    wget https://github.com/loft-sh/vcluster/releases/download/v${VERSION}/vcluster-images.txt
    wget https://github.com/loft-sh/vcluster/releases/download/v${VERSION}/download-images.sh
    wget https://github.com/loft-sh/vcluster/releases/download/v${VERSION}/push-images.sh
    chmod +x *.sh
    ```
  </Step>
  <Step>
    Download images:
    ```bash
    ./download-images.sh --image-list vcluster-images.txt
    ```
  </Step>
  <Step>
    Push to your registry:
    ```bash
    ./push-images.sh --registry ${REGISTRY}
    ```
  </Step>
</Flow>

:::info
You can remove images from `vcluster-images.txt` that you don't need.
:::

## Configure vcluster.yaml

### Configure vCluster

Configure your vCluster to point to the appropriate Helm chart location and image registry:

```yaml
controlPlane:
  advanced:
    defaultImageRegistry: ${REGISTRY}
  distro:
    k8s:
      version: v1.31.1
```

:::info
Example registry path: `ecr.io/myteam/ghcr.io/loft-sh/vcluster:0.21.0`
:::

:::info
To override the Alpine init image:
```yaml
sync:
  toHost:
    pods:
      rewriteHosts:
        initContainer:
          image: your-registry/your-image:1.0.0
```
The replacement image must support `sh` and basic `sed`.
:::

### Configure image pull secret for image registry

```yaml
controlPlane:
  advanced:
    serviceAccount:
      imagePullSecrets:
        - name: your-image-pull-secret
```

### Connect to the platform

#### Configure the API key

```yaml
external:
  platform:
    apiKey:
      secretName: vcluster-platform-api-key
      namespace: vcluster-ns
      createRBAC: true
```

```bash
export VCLUSTER_LICENSE_KEY="YOUR_BASE64_ENCODED_LICENSE_KEY"
kubectl create namespace vcluster-ns
kubectl create -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: vcluster-platform-api-key
  namespace: vcluster-ns
type: Opaque
data:
  license: ${VCLUSTER_LICENSE_KEY}
EOF
```

### Configure FIPS images

To run vCluster in a FIPS compliant environment, the `vcluster.yaml` needs to be configured to use the Loft GitHub Container Registry with the FIPS compliant images for the syncer (vCluster control plane `StatefulSet`) and the Kubernetes distro images and configured to use the vCluster Pro embedded CoreDNS.

:::info
Refer to the [FIPS configuration guide](/vcluster/deploy/security/fips) for more details.
:::

The following is an example `vcluster.yaml` configuration of air-gapped vCluster Pro with FIPS compliant images and assumes you have created a `Secret` named `vcluster-platform-api-key` with the air-gapped license key provided by Loft in the same `Namespace` where you are deploying the vCluster instance

<details>
  <summary>FIPS configuration</summary>
  <FipsConfig />
</details>

## Deploy vCluster

```bash
helm upgrade --install vcluster vcluster-${VERSION}.tgz \
  --version ${VERSION} \
  --values vcluster.yaml \
  --namespace vcluster-ns
```